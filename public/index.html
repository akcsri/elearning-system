<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼å–å¼•è¦åˆ¶ eãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAA0ElEQVRYhe2WQQqDMBBF3yR4/9vYA3gLb+MBXLmQbhQhkMkkVloI/wFBnPn5M4kxaRQAAAAA8C8MAc5bXyNwDnAJ8PKT/7gGOFu9CwFeCXBL8lKAs9V7EeAdACsB3gGwEuAdACsB3gGwEuAdACsB3gGwEuAdACsB3gGwEuAdACsB3gGwEuDdAPcGONv+LQBXq/cmwDsBVgK8E2AlwDsBVgK8E2AlwDsBVgK8E2AlwDsBVgK8E2AlwDsBVgK8G+CXtb8R4Bxgf1v9b0AAAAAA/MwbqfYcMcE7EFIAAAAASUVORK5CYII=">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header-left p {
            font-size: 14px;
            opacity: 0.9;
        }

        .progress-bar-container {
            background: rgba(255, 255, 255, 0.2);
            height: 8px;
            margin-top: 20px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #4ade80;
            transition: width 0.3s ease;
        }

        .content-area {
            padding: 40px;
        }

        .slide-container {
            min-height: 500px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 30px;
            position: relative;
            padding: 20px 0;
        }

        .slide-image {
            width: 100%;
            max-width: 1200px;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .slide-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 1200px;
        }
        
        .slide-nav-button {
            flex-shrink: 0;
            min-width: 120px;
        }

        @media (max-width: 992px) {
            .slide-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .slide-nav-button {
                min-width: 100px;
            }
        }

        @media (max-width: 768px) {
            .content-area {
                padding: 20px;
            }
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quiz-question {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 900px;
            margin: 0 auto;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .question-number {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        .question-text {
            font-size: 20px;
            font-weight: 600;
            color: #1e3c72;
            line-height: 1.8;
            margin: 30px 0;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
        }

        .option-button {
            padding: 20px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 12px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .option-button:hover {
            border-color: #667eea;
            background: #f3f4f6;
            transform: translateX(5px);
        }

        .option-button.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .login-container {
            max-width: 450px;
            margin: 50px auto;
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h2 {
            font-size: 28px;
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .admin-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
        }

        .dashboard-card h3 {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .dashboard-card p {
            opacity: 0.9;
            font-size: 16px;
        }

        .admin-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 40px;
        }

        .learners-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .learners-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .learners-table th {
            background: #1e3c72;
            color: white;
            padding: 16px;
            text-align: left;
            font-weight: 600;
        }

        .learners-table td {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .learners-table tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-in-progress {
            background: #fef3c7;
            color: #92400e;
        }

        .status-not-started {
            background: #e5e7eb;
            color: #374151;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 0;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }

        .modal-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
        }

        .certificate-container {
            background: white;
            border: 3px solid #1e3c72;
            border-radius: 12px;
            padding: 50px;
            margin: 30px;
            text-align: center;
        }

        .certificate-title {
            font-size: 36px;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 30px;
        }

        .certificate-name {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin: 20px 0;
            padding: 10px;
            border-bottom: 2px solid #1e3c72;
        }

        .certificate-body {
            line-height: 1.8;
            font-size: 18px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .loading-spinner {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #667eea;
        }

        .course-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .course-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .course-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }

        .course-card h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .course-card p {
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .course-progress {
            margin-top: 15px;
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ===========================================
        // ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½ã®ã‚¨ãƒ©ãƒ¼ã‚’æŠ‘åˆ¶
        // ===========================================
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('message channel closed')) {
                e.preventDefault();
                return true;
            }
        });

        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && e.reason.message && e.reason.message.includes('message channel closed')) {
                e.preventDefault();
                return true;
            }
        });

        // ===========================================
        // ğŸ”§ PostgreSQL APIè¨­å®š
        // ===========================================
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api'
            : '/api';

        console.log('ğŸš€ eãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•');
        console.log('ğŸ“¡ API Base:', API_BASE);

        // ===========================================
        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆPostgreSQL APIä½¿ç”¨ï¼‰
        // ===========================================
        const Database = {
            async load() {
                try {
                    console.log('ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                    const url = `${API_BASE}/data`;
                    console.log('ğŸŒ API URL:', url);
                    
                    const response = await fetch(url);
                    console.log('ğŸ“Š ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('âŒ APIã‚¨ãƒ©ãƒ¼:', errorText);
                        throw new Error(`ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ (${response.status})`);
                    }
                    
                    const data = await response.json();
                    console.log('âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ');
                    console.log('  - ãƒ¦ãƒ¼ã‚¶ãƒ¼:', data.users?.length || 0, 'äºº');
                    console.log('  - ã‚³ãƒ¼ã‚¹:', data.courses?.length || 0, 'ä»¶');
                    console.log('  - å­¦ç¿’è¨˜éŒ²:', data.learningRecords?.length || 0, 'ä»¶');
                    
                    return data;
                } catch (error) {
                    console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    return null;
                }
            },

            async saveProgress(userId, progressData) {
                try {
                    const response = await fetch(`${API_BASE}/progress/${userId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(progressData)
                    });
                    return response.ok;
                } catch (error) {
                    console.error('é€²æ—ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    return false;
                }
            },

            async loadProgress(userId, courseId) {
                try {
                    const response = await fetch(`${API_BASE}/progress/${userId}?courseId=${courseId}`);
                    if (response.ok) {
                        return await response.json();
                    }
                    return null;
                } catch (error) {
                    console.error('é€²æ—èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    return null;
                }
            },

            async deleteProgress(userId, courseId) {
                try {
                    const url = courseId 
                        ? `${API_BASE}/progress/${userId}?courseId=${courseId}`
                        : `${API_BASE}/progress/${userId}`;
                    const response = await fetch(url, { method: 'DELETE' });
                    return response.ok;
                } catch (error) {
                    console.error('é€²æ—å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    return false;
                }
            },

            async saveLearningRecord(recordData) {
                try {
                    const response = await fetch(`${API_BASE}/learning-records`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(recordData)
                    });
                    return response.ok;
                } catch (error) {
                    console.error('å­¦ç¿’è¨˜éŒ²ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    return false;
                }
            },

            async getCourseById(courseId) {
                try {
                    const response = await fetch(`${API_BASE}/courses/${courseId}`);
                    if (!response.ok) throw new Error('ã‚³ãƒ¼ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return await response.json();
                } catch (error) {
                    console.error('ã‚³ãƒ¼ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    return null;
                }
            }
        };

        // ===========================================
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿
        // ===========================================
        let AppData = {
            users: [],
            courses: [],
            learningRecords: [],
            currentUser: null,
            currentCourse: null,
            currentSlideIndex: 0,
            currentQuestionIndex: 0,
            userAnswers: {},
            startTime: null
        };

        // ===========================================
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
        // ===========================================
        const App = {
            async init() {
                console.log('ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ä¸­...');
                
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                const data = await Database.load();
                if (data) {
                    AppData.users = data.users || [];
                    AppData.courses = data.courses || [];
                    AppData.learningRecords = data.learningRecords || [];
                    console.log('âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
                } else {
                    console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—');
                    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
                const savedUser = sessionStorage.getItem('currentUser');
                if (savedUser) {
                    AppData.currentUser = JSON.parse(savedUser);
                    this.showMainScreen();
                } else {
                    this.showLogin();
                }
            },

            showLogin() {
                const html = `
                    <div class="login-container">
                        <div class="login-header">
                            <h2>ğŸ“ eãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ </h2>
                            <p>ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼å–å¼•è¦åˆ¶ç ”ä¿®</p>
                        </div>
                        <form id="loginForm">
                            <div class="form-group">
                                <label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                                <input type="text" id="username" required autofocus>
                            </div>
                            <div class="form-group">
                                <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                                <input type="password" id="password" required>
                            </div>
                            <div id="loginError"></div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                ãƒ­ã‚°ã‚¤ãƒ³
                            </button>
                        </form>
                    </div>
                `;
                
                document.getElementById('app').innerHTML = html;
                
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
            },

            handleLogin() {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                
                const user = AppData.users.find(u => 
                    u.username === username && u.password === password
                );
                
                if (user) {
                    AppData.currentUser = user;
                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                    this.showMainScreen();
                } else {
                    document.getElementById('loginError').innerHTML = 
                        '<div class="error-message">ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</div>';
                }
            },

            logout() {
                AppData.currentUser = null;
                sessionStorage.removeItem('currentUser');
                this.showLogin();
            },

            showMainScreen() {
                if (AppData.currentUser.role === 'admin') {
                    this.showAdminDashboard();
                } else {
                    this.showUserDashboard();
                }
            },

            showAdminDashboard() {
                const totalLearners = AppData.users.filter(u => u.role === 'user').length;
                const completedCount = new Set(
                    AppData.learningRecords.filter(r => r.passed).map(r => r.userId)
                ).size;
                const inProgressCount = totalLearners - completedCount;

                const html = `
                    <div class="app-container">
                        <div class="header">
                            <div class="header-left">
                                <h1>ğŸ“Š ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                                <p>ã‚ˆã†ã“ãã€${AppData.currentUser.name} ã•ã‚“</p>
                            </div>
                            <button class="btn btn-logout" onclick="App.logout()">
                                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                            </button>
                        </div>
                        
                        <div class="content-area">
                            <div class="admin-dashboard">
                                <div class="dashboard-card">
                                    <h3>${totalLearners}</h3>
                                    <p>ç·å—è¬›è€…æ•°</p>
                                </div>
                                <div class="dashboard-card">
                                    <h3>${completedCount}</h3>
                                    <p>ä¿®äº†è€…æ•°</p>
                                </div>
                                <div class="dashboard-card">
                                    <h3>${inProgressCount}</h3>
                                    <p>æœªä¿®äº†è€…æ•°</p>
                                </div>
                                <div class="dashboard-card">
                                    <h3>${AppData.courses.length}</h3>
                                    <p>ã‚³ãƒ¼ã‚¹æ•°</p>
                                </div>
                            </div>

                            <div class="admin-actions">
                                <button class="btn btn-primary" onclick="window.location.href='user-management.html'">
                                    ğŸ‘¥ å—è¬›è€…ç®¡ç†
                                </button>
                                <button class="btn btn-success" onclick="App.exportData()">
                                    ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                                </button>
                                <button class="btn btn-warning" onclick="App.viewAllRecords()">
                                    ğŸ“‹ å…¨å­¦ç¿’è¨˜éŒ²ã‚’è¡¨ç¤º
                                </button>
                            </div>

                            <h2 style="margin-bottom: 20px; color: #1e3c72;">å—è¬›è€…ä¸€è¦§</h2>
                            ${this.renderLearnersTable()}
                        </div>
                    </div>
                `;
                
                document.getElementById('app').innerHTML = html;
            },

            renderLearnersTable() {
                const learners = AppData.users.filter(u => u.role === 'user');
                
                if (learners.length === 0) {
                    return '<p style="text-align: center; padding: 40px; color: #6b7280;">å—è¬›è€…ãŒã„ã¾ã›ã‚“</p>';
                }

                const rows = learners.map(learner => {
                    const records = AppData.learningRecords.filter(r => r.userId === learner.id && r.passed);
                    const status = records.length > 0 ? 'completed' : 'not-started';
                    
                    let statusBadge, statusText;
                    if (status === 'completed') {
                        statusBadge = 'status-completed';
                        statusText = 'âœ… ä¿®äº†';
                    } else {
                        statusBadge = 'status-not-started';
                        statusText = 'â³ æœªå—è¬›';
                    }

                    return `
                        <tr>
                            <td>${learner.name}</td>
                            <td>${learner.department || '-'}</td>
                            <td>${learner.email}</td>
                            <td>
                                <span class="status-badge ${statusBadge}">${statusText}</span>
                            </td>
                            <td>
                                <button class="btn btn-small btn-primary" onclick="AdminScreen.viewLearnerDetail(${learner.id})">
                                    è©³ç´°
                                </button>
                                ${status === 'completed' ? `
                                    <button class="btn btn-small btn-success" onclick="AdminScreen.viewCertificate(${learner.id})">
                                        ä¿®äº†è¨¼
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div class="learners-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>æ°å</th>
                                    <th>éƒ¨ç½²</th>
                                    <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            showUserDashboard() {
                const userRecords = AppData.learningRecords.filter(r => 
                    r.userId === AppData.currentUser.id && r.passed
                );
                
                const completedCourseIds = new Set(userRecords.map(r => r.courseId));

                const html = `
                    <div class="app-container">
                        <div class="header">
                            <div class="header-left">
                                <h1>ğŸ“ ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
                                <p>ã‚ˆã†ã“ãã€${AppData.currentUser.name} ã•ã‚“</p>
                            </div>
                            <button class="btn btn-logout" onclick="App.logout()">
                                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                            </button>
                        </div>
                        
                        <div class="content-area">
                            <h2 style="margin-bottom: 20px; color: #1e3c72;">åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ¼ã‚¹</h2>
                            ${this.renderCourseList(completedCourseIds)}
                        </div>
                    </div>
                `;
                
                document.getElementById('app').innerHTML = html;
            },

            renderCourseList(completedCourseIds) {
                if (AppData.courses.length === 0) {
                    return '<p style="text-align: center; padding: 40px; color: #6b7280;">åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                }

                const cards = AppData.courses.map(course => {
                    const isCompleted = completedCourseIds.has(course.id);
                    
                    return `
                        <div class="course-card" onclick="App.startCourse(${course.id})">
                            <h3>${course.title}</h3>
                            <p>${course.description || 'ã‚³ãƒ¼ã‚¹ã®èª¬æ˜ãŒã‚ã‚Šã¾ã›ã‚“'}</p>
                            ${isCompleted ? `
                                <div class="course-progress">âœ… ä¿®äº†æ¸ˆã¿</div>
                            ` : `
                                <button class="btn btn-primary" style="width: 100%;">
                                    ã‚³ãƒ¼ã‚¹ã‚’é–‹å§‹
                                </button>
                            `}
                        </div>
                    `;
                }).join('');

                return `<div class="course-list">${cards}</div>`;
            },

            async startCourse(courseId) {
                console.log('ğŸ“š ã‚³ãƒ¼ã‚¹é–‹å§‹:', courseId);
                
                // è©³ç´°ãªã‚³ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const course = await Database.getCourseById(courseId);
                if (!course) {
                    alert('ã‚³ãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }

                AppData.currentCourse = course;
                AppData.currentSlideIndex = 0;
                AppData.startTime = Date.now();

                // ä¿å­˜ã•ã‚ŒãŸé€²æ—ã‚’ç¢ºèª
                const savedProgress = await Database.loadProgress(
                    AppData.currentUser.id, 
                    courseId
                );

                if (savedProgress && !savedProgress.quiz_started) {
                    if (confirm('å‰å›ã®ç¶šãã‹ã‚‰å†é–‹ã—ã¾ã™ã‹?')) {
                        AppData.currentSlideIndex = savedProgress.current_slide || 0;
                    }
                }

                this.showTrainingSlides();
            },

            showTrainingSlides() {
                const course = AppData.currentCourse;
                const slideImages = course.slideImages || [];
                const totalSlides = slideImages.length;

                if (totalSlides === 0) {
                    alert('ã“ã®ã‚³ãƒ¼ã‚¹ã«ã¯ã‚¹ãƒ©ã‚¤ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
                    this.showUserDashboard();
                    return;
                }

                const currentSlide = slideImages[AppData.currentSlideIndex];
                const progress = ((AppData.currentSlideIndex + 1) / totalSlides) * 100;

                const html = `
                    <div class="app-container">
                        <div class="header">
                            <div class="header-left">
                                <h1>${course.title}</h1>
                                <p>ã‚¹ãƒ©ã‚¤ãƒ‰ ${AppData.currentSlideIndex + 1} / ${totalSlides}</p>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <button class="btn btn-logout" onclick="App.exitCourse()">
                                Ã— çµ‚äº†
                            </button>
                        </div>
                        
                        <div class="content-area">
                            <div class="slide-container">
                                ${AppData.currentSlideIndex > 0 ? `
                                    <button class="btn btn-secondary slide-nav-button" onclick="App.previousSlide()">
                                        â† å‰ã¸
                                    </button>
                                ` : '<div style="min-width: 120px;"></div>'}
                                
                                <div class="slide-content-wrapper">
                                    <img src="${currentSlide.data}" alt="ã‚¹ãƒ©ã‚¤ãƒ‰ ${AppData.currentSlideIndex + 1}" class="slide-image">
                                </div>
                                
                                ${AppData.currentSlideIndex < totalSlides - 1 ? `
                                    <button class="btn btn-primary slide-nav-button" onclick="App.nextSlide()">
                                        æ¬¡ã¸ â†’
                                    </button>
                                ` : `
                                    <button class="btn btn-success slide-nav-button" onclick="App.startQuiz()">
                                        ãƒ†ã‚¹ãƒˆé–‹å§‹ â†’
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('app').innerHTML = html;
                
                // é€²æ—ã‚’è‡ªå‹•ä¿å­˜
                this.saveCurrentProgress();
            },

            async saveCurrentProgress() {
                const progressData = {
                    course_id: AppData.currentCourse.id,
                    current_slide: AppData.currentSlideIndex,
                    quiz_started: false,
                    quiz_answers: [],
                    expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                };

                await Database.saveProgress(AppData.currentUser.id, progressData);
            },

            previousSlide() {
                if (AppData.currentSlideIndex > 0) {
                    AppData.currentSlideIndex--;
                    this.showTrainingSlides();
                }
            },

            nextSlide() {
                const totalSlides = (AppData.currentCourse.slideImages || []).length;
                if (AppData.currentSlideIndex < totalSlides - 1) {
                    AppData.currentSlideIndex++;
                    this.showTrainingSlides();
                }
            },

            startQuiz() {
                const quiz = AppData.currentCourse.quiz || [];
                
                if (quiz.length === 0) {
                    alert('ã“ã®ã‚³ãƒ¼ã‚¹ã«ã¯ãƒ†ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                AppData.currentQuestionIndex = 0;
                AppData.userAnswers = {};
                this.showQuizQuestion();
            },

            showQuizQuestion() {
                const quiz = AppData.currentCourse.quiz;
                const question = quiz[AppData.currentQuestionIndex];
                const totalQuestions = quiz.length;
                const progress = ((AppData.currentQuestionIndex + 1) / totalQuestions) * 100;

                const optionsHtml = question.options.map((option, index) => {
                    const isSelected = AppData.userAnswers[AppData.currentQuestionIndex] === index;
                    return `
                        <button class="option-button ${isSelected ? 'selected' : ''}" 
                                onclick="App.selectAnswer(${index})">
                            ${String.fromCharCode(65 + index)}. ${option}
                        </button>
                    `;
                }).join('');

                const html = `
                    <div class="app-container">
                        <div class="header">
                            <div class="header-left">
                                <h1>ğŸ“ ç¢ºèªãƒ†ã‚¹ãƒˆ</h1>
                                <p>å•é¡Œ ${AppData.currentQuestionIndex + 1} / ${totalQuestions}</p>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <button class="btn btn-logout" onclick="App.exitCourse()">
                                Ã— çµ‚äº†
                            </button>
                        </div>
                        
                        <div class="content-area">
                            <div class="quiz-question">
                                <div class="question-header">
                                    <span class="question-number">å•é¡Œ ${AppData.currentQuestionIndex + 1}</span>
                                    <span style="color: #6b7280;">å›ç­”æ¸ˆã¿: ${Object.keys(AppData.userAnswers).length} / ${totalQuestions}</span>
                                </div>
                                
                                <div class="question-text">
                                    ${question.question}
                                </div>
                                
                                <div class="options">
                                    ${optionsHtml}
                                </div>
                                
                                <div class="navigation">
                                    ${AppData.currentQuestionIndex > 0 ? `
                                        <button class="btn btn-secondary" onclick="App.previousQuestion()">
                                            â† å‰ã®å•é¡Œ
                                        </button>
                                    ` : '<div></div>'}
                                    
                                    ${AppData.currentQuestionIndex < totalQuestions - 1 ? `
                                        <button class="btn btn-primary" onclick="App.nextQuestion()">
                                            æ¬¡ã®å•é¡Œ â†’
                                        </button>
                                    ` : `
                                        <button class="btn btn-success" onclick="App.submitQuiz()">
                                            å›ç­”ã‚’æå‡º
                                        </button>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('app').innerHTML = html;
            },

            selectAnswer(answerIndex) {
                AppData.userAnswers[AppData.currentQuestionIndex] = answerIndex;
                this.showQuizQuestion();
            },

            previousQuestion() {
                if (AppData.currentQuestionIndex > 0) {
                    AppData.currentQuestionIndex--;
                    this.showQuizQuestion();
                }
            },

            nextQuestion() {
                const totalQuestions = AppData.currentCourse.quiz.length;
                if (AppData.currentQuestionIndex < totalQuestions - 1) {
                    AppData.currentQuestionIndex++;
                    this.showQuizQuestion();
                }
            },

            async submitQuiz() {
                const quiz = AppData.currentCourse.quiz;
                const totalQuestions = quiz.length;
                const answeredCount = Object.keys(AppData.userAnswers).length;

                if (answeredCount < totalQuestions) {
                    if (!confirm(`æœªå›ç­”ã®å•é¡ŒãŒ ${totalQuestions - answeredCount} å•ã‚ã‚Šã¾ã™ã€‚\n\nã“ã®ã¾ã¾æå‡ºã—ã¾ã™ã‹?`)) {
                        return;
                    }
                }

                // æ¡ç‚¹
                let correctCount = 0;
                const results = quiz.map((q, index) => {
                    const userAnswer = AppData.userAnswers[index];
                    const isCorrect = userAnswer === q.correctAnswer;
                    if (isCorrect) correctCount++;
                    return {
                        question: q.question,
                        userAnswer,
                        correctAnswer: q.correctAnswer,
                        isCorrect
                    };
                });

                const score = correctCount;
                const passingScore = AppData.currentCourse.passing_score || 7;
                const passed = score >= passingScore;
                const timeSpent = Math.floor((Date.now() - AppData.startTime) / 1000);

                // å­¦ç¿’è¨˜éŒ²ã‚’ä¿å­˜
                const recordData = {
                    user_id: AppData.currentUser.id,
                    course_id: AppData.currentCourse.id,
                    score: score,
                    passed: passed,
                    answers: results,
                    time_spent: timeSpent
                };

                const saved = await Database.saveLearningRecord(recordData);
                
                if (saved) {
                    // é€²æ—ã‚’å‰Šé™¤
                    await Database.deleteProgress(AppData.currentUser.id, AppData.currentCourse.id);
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    const data = await Database.load();
                    if (data) {
                        AppData.learningRecords = data.learningRecords || [];
                    }
                }

                this.showQuizResult(score, totalQuestions, passed, passingScore);
            },

            showQuizResult(score, totalQuestions, passed, passingScore) {
                const percentage = Math.round((score / totalQuestions) * 100);

                const html = `
                    <div class="app-container">
                        <div class="header">
                            <div class="header-left">
                                <h1>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ</h1>
                                <p>${AppData.currentCourse.title}</p>
                            </div>
                        </div>
                        
                        <div class="content-area" style="text-align: center;">
                            <div style="background: ${passed ? '#d1fae5' : '#fee2e2'}; 
                                        border: 3px solid ${passed ? '#10b981' : '#ef4444'};
                                        border-radius: 16px;
                                        padding: 50px;
                                        max-width: 600px;
                                        margin: 0 auto;">
                                
                                <h2 style="font-size: 48px; margin-bottom: 20px;">
                                    ${passed ? 'ğŸ‰ åˆæ ¼' : 'ğŸ˜” ä¸åˆæ ¼'}
                                </h2>
                                
                                <div style="font-size: 72px; font-weight: 700; 
                                            color: ${passed ? '#10b981' : '#ef4444'};
                                            margin: 30px 0;">
                                    ${score} / ${totalQuestions}
                                </div>
                                
                                <p style="font-size: 24px; color: #374151;">
                                    æ­£ç­”ç‡: ${percentage}%
                                </p>
                                
                                <p style="margin-top: 20px; font-size: 16px; color: #6b7280;">
                                    åˆæ ¼ãƒ©ã‚¤ãƒ³: ${passingScore}å•ä»¥ä¸Šæ­£è§£
                                </p>
                            </div>
                            
                            <div style="margin-top: 40px; display: flex; gap: 15px; justify-content: center;">
                                <button class="btn btn-primary" onclick="App.showUserDashboard()">
                                    ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
                                </button>
                                ${passed ? `
                                    <button class="btn btn-success" onclick="UserScreen.viewMyCertificate()">
                                        ğŸ“œ ä¿®äº†è¨¼ã‚’è¡¨ç¤º
                                    </button>
                                ` : `
                                    <button class="btn btn-warning" onclick="App.startCourse(${AppData.currentCourse.id})">
                                        ã‚‚ã†ä¸€åº¦å—è¬›
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('app').innerHTML = html;
            },

            async exitCourse() {
                if (confirm('ã‚³ãƒ¼ã‚¹ã‚’çµ‚äº†ã—ã¾ã™ã‹?\n\né€²æ—ã¯ä¿å­˜ã•ã‚Œã¾ã™ã€‚')) {
                    await this.saveCurrentProgress();
                    this.showUserDashboard();
                }
            },

            async exportData() {
                try {
                    const response = await fetch(`${API_BASE}/export`);
                    if (!response.ok) throw new Error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `elearning_backup_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ!');
                } catch (error) {
                    alert('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            },

            viewAllRecords() {
                AdminScreen.viewAllRecords();
            }
        };

        // ===========================================
        // ç®¡ç†è€…ç”»é¢æ©Ÿèƒ½
        // ===========================================
        const AdminScreen = {
            async viewLearnerDetail(userId) {
                const learner = AppData.users.find(u => u.id === userId);
                const records = AppData.learningRecords.filter(r => r.userId === userId);
                const progress = await Database.loadProgress(userId, AppData.courses[0]?.id);
                
                if (!learner) return;
                
                let progressHtml = '';
                if (progress && !progress.quiz_started) {
                    progressHtml = `
                        <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin: 20px 30px; border: 2px solid #f59e0b;">
                            <h4 style="color: #92400e; margin-bottom: 10px;">â¸ï¸ é€²è¡Œä¸­</h4>
                            <p><strong>é€²æ—:</strong> ã‚¹ãƒ©ã‚¤ãƒ‰ ${(progress.current_slide || 0) + 1}</p>
                            <p><strong>æœ€çµ‚æ›´æ–°:</strong> ${new Date(progress.updated_at).toLocaleString('ja-JP')}</p>
                        </div>
                    `;
                }
                
                let recordsHtml = '';
                if (records.length === 0) {
                    recordsHtml = '<p style="color: #6b7280; text-align: center; padding: 20px;">å—è¬›å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                } else {
                    recordsHtml = records.map((record, index) => `
                        <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="color: #1e3c72; margin-bottom: 10px;">å—è¬›è¨˜éŒ² #${index + 1}</h4>
                            <p><strong>ã‚³ãƒ¼ã‚¹:</strong> ${record.courseTitle || 'ã‚³ãƒ¼ã‚¹åä¸æ˜'}</p>
                            <p><strong>å®Œäº†æ—¥:</strong> ${new Date(record.completedAt || record.completedDate).toLocaleString('ja-JP')}</p>
                            <p><strong>ãƒ†ã‚¹ãƒˆçµæœ:</strong> <span style="color: ${record.passed ? '#10b981' : '#ef4444'}; font-weight: 600;">${record.score}ç‚¹</span></p>
                            <p><strong>åˆ¤å®š:</strong> ${record.passed ? '<span style="color: #10b981;">âœ… åˆæ ¼</span>' : '<span style="color: #ef4444;">âŒ ä¸åˆæ ¼</span>'}</p>
                        </div>
                    `).join('');
                }
                
                const modal = `
                    <div class="modal active" onclick="if(event.target === this) this.remove()">
                        <div class="modal-content" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h2>ğŸ‘¤ å—è¬›è€…è©³ç´°</h2>
                                <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
                            </div>
                            <div style="padding: 30px;">
                                <h3 style="color: #1e3c72; margin-bottom: 15px;">åŸºæœ¬æƒ…å ±</h3>
                                <p><strong>æ°å:</strong> ${learner.name}</p>
                                <p><strong>éƒ¨ç½²:</strong> ${learner.department || '-'}</p>
                                <p><strong>ãƒ¡ãƒ¼ãƒ«:</strong> ${learner.email}</p>
                                <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> ${learner.username}</p>
                            </div>
                            ${progressHtml}
                            <div style="padding: 0 30px 30px 30px;">
                                <h3 style="color: #1e3c72; margin-bottom: 15px;">å—è¬›å±¥æ­´</h3>
                                ${recordsHtml}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modal);
            },

            viewCertificate(userId) {
                const learner = AppData.users.find(u => u.id === userId);
                const records = AppData.learningRecords.filter(r => r.userId === userId && r.passed);
                
                if (!learner || records.length === 0) {
                    alert('ä¿®äº†è¨¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const latestRecord = records[records.length - 1];
                
                const modal = `
                    <div class="modal active" onclick="if(event.target === this) this.remove()">
                        <div class="modal-content" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h2>ğŸ“œ ä¿®äº†è¨¼</h2>
                                <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
                            </div>
                            <div class="certificate-container">
                                <div class="certificate-title">ğŸ† ä¿®äº†è¨¼</div>
                                <div class="certificate-body">
                                    <p style="font-size: 20px; margin-bottom: 20px;">ä»¥ä¸‹ã®è€…ã¯</p>
                                    <div class="certificate-name">${latestRecord.userName || learner.name}</div>
                                    <p style="margin: 20px 0; line-height: 1.8;">
                                        ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼å–å¼•è¦åˆ¶ã«ãŠã‘ã‚‹<br>
                                        å–å¼•æ¨å¥¨è¡Œç‚ºã«é–¢ã™ã‚‹ç ”ä¿®ã‚’<br>
                                        ä¿®äº†ã—ãŸã“ã¨ã‚’è¨¼æ˜ã—ã¾ã™
                                    </p>
                                    <p style="margin-top: 30px; color: #6b7280;">
                                        ${new Date(latestRecord.completedAt || latestRecord.completedDate).toLocaleDateString('ja-JP')}
                                    </p>
                                    <p style="margin-top: 10px; font-weight: 600;">
                                        ${latestRecord.userDept || learner.department || ''}
                                    </p>
                                    <p style="margin-top: 20px; color: #6b7280; font-size: 14px;">
                                        ãƒ†ã‚¹ãƒˆçµæœ: ${latestRecord.score}ç‚¹
                                    </p>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 20px;">
                                <button class="btn btn-primary" onclick="window.print()">
                                    ğŸ–¨ï¸ å°åˆ·
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modal);
            },

            viewAllRecords() {
                if (AppData.learningRecords.length === 0) {
                    alert('å­¦ç¿’è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                const recordsHtml = AppData.learningRecords.map((record, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${record.userName || 'ä¸æ˜'}</td>
                        <td>${record.courseTitle || 'ä¸æ˜'}</td>
                        <td>${new Date(record.completedAt || record.completedDate).toLocaleString('ja-JP')}</td>
                        <td style="text-align: center;">${record.score}</td>
                        <td style="text-align: center;">
                            <span class="status-badge ${record.passed ? 'status-completed' : 'status-not-started'}">
                                ${record.passed ? 'âœ… åˆæ ¼' : 'âŒ ä¸åˆæ ¼'}
                            </span>
                        </td>
                    </tr>
                `).join('');

                const modal = `
                    <div class="modal active" onclick="if(event.target === this) this.remove()">
                        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 1000px;">
                            <div class="modal-header">
                                <h2>ğŸ“‹ å…¨å­¦ç¿’è¨˜éŒ²</h2>
                                <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
                            </div>
                            <div style="padding: 30px; max-height: 70vh; overflow-y: auto;">
                                <div class="learners-table">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>å—è¬›è€…</th>
                                                <th>ã‚³ãƒ¼ã‚¹</th>
                                                <th>å®Œäº†æ—¥æ™‚</th>
                                                <th style="text-align: center;">å¾—ç‚¹</th>
                                                <th style="text-align: center;">åˆ¤å®š</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${recordsHtml}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modal);
            }
        };

        // ===========================================
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢æ©Ÿèƒ½
        // ===========================================
        const UserScreen = {
            viewMyCertificate() {
                const records = AppData.learningRecords.filter(r => 
                    r.userId === AppData.currentUser.id && r.passed
                );
                
                if (records.length === 0) {
                    alert('ä¿®äº†è¨¼ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const latestRecord = records[records.length - 1];
                
                const modal = `
                    <div class="modal active" onclick="if(event.target === this) this.remove()">
                        <div class="modal-content" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h2>ğŸ“œ ä¿®äº†è¨¼</h2>
                                <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
                            </div>
                            <div class="certificate-container">
                                <div class="certificate-title">ğŸ† ä¿®äº†è¨¼</div>
                                <div class="certificate-body">
                                    <p style="font-size: 20px; margin-bottom: 20px;">ä»¥ä¸‹ã®è€…ã¯</p>
                                    <div class="certificate-name">${AppData.currentUser.name}</div>
                                    <p style="margin: 20px 0; line-height: 1.8;">
                                        ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼å–å¼•è¦åˆ¶ã«ãŠã‘ã‚‹<br>
                                        å–å¼•æ¨å¥¨è¡Œç‚ºã«é–¢ã™ã‚‹ç ”ä¿®ã‚’<br>
                                        ä¿®äº†ã—ãŸã“ã¨ã‚’è¨¼æ˜ã—ã¾ã™
                                    </p>
                                    <p style="margin-top: 30px; color: #6b7280;">
                                        ${new Date(latestRecord.completedAt || latestRecord.completedDate).toLocaleDateString('ja-JP')}
                                    </p>
                                    <p style="margin-top: 10px; font-weight: 600;">
                                        ${AppData.currentUser.department}
                                    </p>
                                    <p style="margin-top: 20px; color: #6b7280; font-size: 14px;">
                                        ãƒ†ã‚¹ãƒˆçµæœ: ${latestRecord.score}ç‚¹
                                    </p>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 20px;">
                                <button class="btn btn-primary" onclick="window.print()">
                                    ğŸ–¨ï¸ å°åˆ·
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modal);
            }
        };

        // ===========================================
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
        // ===========================================
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>
